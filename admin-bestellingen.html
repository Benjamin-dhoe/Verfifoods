<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>admin</title>
  <meta content="admin" property="og:title">
  <meta content="admin" property="twitter:title">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="/css/normalize.css" rel="stylesheet" type="text/css">
  <link href="/css/webflow.css" rel="stylesheet" type="text/css">
  <link href="/css/verfifoods-4d83b7.webflow.css" rel="stylesheet" type="text/css">
  <script src="https://use.typekit.net/nnx8vsx.js" type="text/javascript"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
  <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
  <link href="/images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="/images/webclip.png" rel="apple-touch-icon">
  <link rel="stylesheet" href="https://use.typekit.net/nnx8vsx.css">
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body class="body">  
  <div class="_100-widthcenter">
    <div class="containcenter dashboard">
      <div class="holdertopdashboard">
        <a href="/index.html" class="w-inline-block"><img src="/images/logo-Verfifoods.png" loading="lazy" width="120" alt=""></a>
        <div class="brownundertitle">Admin</div>
      </div>
      <div class="holderdashboardcontent">
        <div class="holderlinksdashboard">
          <div class="menuicondash close" closesidemenu>
              <div class="bold-text">X</div>
          </div>
          <a href="/admin/bestellingen" class="mapslink _10down">
            <div class="typefoodicon dash"><img src="/images/ordericon.svg" loading="lazy" alt=""></div>
            <div class="brownundertitle bold-text">Bestellingen</div>
          </a>
          <a href="/admin/klanten" class="mapslink _10down">
            <div class="typefoodicon dash"><img src="/images/usericon.svg" loading="lazy" alt=""></div>
            <div class="brownundertitle blue">Klanten</div>
          </a>
          <a href="/admin/producten" class="mapslink _10down">
            <div class="typefoodicon dash"><img src="/images/producticon.svg" loading="lazy" alt=""></div>
            <div class="brownundertitle blue">Producten</div>
          </a>
          <a href="/admin/leveranciers" class="mapslink _10down">
            <div class="typefoodicon dash"><img src="/images/breadicon.svg" loading="lazy" alt=""></div>
            <div class="brownundertitle blue">Leveranciers</div>
          </a>
          <div class="spacer10px"></div>
          <div class="spacer10px"></div>
          <div class="spacer10px"></div>
          <a id="logoutBtn" class="mapslink _10down">
            <div class="typefoodicon dash"><img src="/images/logout.svg" loading="lazy" alt=""></div>
            <div class="brownundertitle blue">Uitloggen</div>
          </a>
        </div>
        <div class="holderappdashboard">
          <div class="holderapptop">
            <div class="mapslink _10down">
              <div class="typefoodicon dash"><img src="/images/ordericon.svg" loading="lazy" alt=""></div>
              <div class="brownundertitle bold-text">Bestellingen</div>
            </div>
            <div class="menuicondash" opensidemenu>
              <img src="/images/listicon.svg" loading="lazy" alt="">
            </div>
          </div>
          
          <div class="holderappresults" id="mainresults">
            <div class="100widthcenter">
              <a class="button intypeholder notabs w-button" href="/nl/aanbod">Maak nieuwe bestelling</a>
              <div class="spacer10px"></div>
              <button class="button intypeholder notabs grey w-button" onclick="exportTableToXLSX('tableXL')">Exporteer tabel naar excel</button>
            </div>
            <div class="table-container" id="bestellingenTable">
                <table class="styled-table" id="tableXL">
                    <thead>
                        <tr>
                            <th>Klant</th>
                            <th>BestellingID</th>
                            <th>Admin/user/gast</th>
                            <th>Levering/afhaling</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Totale prijs</th>
                            <th># dozen</th>
                            <th>Email</th>
                            <th>Telefoon</th>
                            <th>Fact</th>
                            <th>Lev</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically added here by the script -->
                    </tbody>
                </table>
              </div>
        </div>

        <div id="popupeditbestelling" class="holderappresults spacebetween" style="display: none;">
          <div class="closebtn" id="closepopupeditbestelling">X</div>
          <div class="leftalignflexvert" style="min-width: 40%;">
                <div class="bold-text brown-text" id="detailbestid"></div>
                <div class="spacer10px"></div>
                <input type="hidden" id="updateid" value="">
                
                  <div id="accountSetupForm">
                    <label class="brownundertitle">B2B of B2C?</label>
                     <div class="radio-container">
                       <label class="radio-label">
                         <input type="radio" name="type" value="personal" class="radio-input" required>
                         B2C-bestelling
                       </label>
                       <label class="radio-label">
                         <input type="radio" name="type" value="business" class="radio-input" required>
                         B2B-bestelling
                       </label>
                     </div>
                    <div class="spacer10px"></div>
                    <label class="brownundertitle">Levering of afhaling?</label>
                    <div class="radio-container">
                      <label class="radio-label">
                        <input type="radio" name="delivery" value="delivery" class="radio-input" required="">
                        Levering
                      </label>
                      <label class="radio-label">
                        <input type="radio" name="delivery" value="pickup" class="radio-input" required="">
                        Afhaling
                      </label>
                    </div>
                     <div class="spacer10px"></div>
                      <label class="brownundertitle">Email</label>
                     <input class="text-field w-input" maxlength="256" type="text" id="email" name="email" required>
                     <label class="brownundertitle">Telefoon</label>
                     <input class="text-field w-input" maxlength="256" type="text" id="telephone" name="telephone" required>
                     <div id="personaldiv" style="display: none;">
                       <label class="brownundertitle">Voornaam</label>
                       <input class="text-field w-input" maxlength="256" type="text" id="firstname" name="firstname" required>
                       <label class="brownundertitle">Naam</label>
                       <input class="text-field w-input" maxlength="256" type="text" id="name" name="name" required>
                     </div>
                     <div id="businessdiv" style="display: none;">
                       <label class="brownundertitle">Bedrijfsnaam</label>
                       <input class="text-field w-input" maxlength="256" type="text" id="companyname" name="companyname" required>
                       <label class="brownundertitle">BTW nummer</label>
                       <input class="text-field w-input" maxlength="256" type="text" id="btwnr" name="btwnr" required>
                       
                     </div>
                     <div>
                       <div class="spacer10px"></div>
                       <label class="brownundertitle bold-text">Factuuradres</label>
                       <label class="brownundertitle">Straat en huisnummer</label>
                       <input class="text-field w-input" maxlength="256" type="text" id="streetnrfact" name="streetnrfact" required>
                       <label class="brownundertitle">Postcode</label>
                       <input class="text-field w-input" maxlength="256" type="text" id="postcodefact" name="postcodefact" required>
                       <label class="brownundertitle">Plaats</label>
                       <input class="text-field w-input" maxlength="256" type="text" id="placefact" name="placefact" required>
                       <div class="spacer10px"></div>
                       <div id="deliverydiv">
                       <label class="brownundertitle bold-text">Leveringsadres</label>
                         <label class="brownundertitle">Straat en huisnummer</label>
                         <input class="text-field w-input" maxlength="256" type="text" id="deliverystreetnr" name="deliverystreetnr" required>
                         <label class="brownundertitle">Postcode</label>
                         <input class="text-field w-input" maxlength="256" type="text" id="deliverypostcode" name="deliverypostcode" required>
                         <label class="brownundertitle">Plaats</label>
                         <input class="text-field w-input" maxlength="256" type="text" id="deliveryplace" name="deliveryplace" required>
                       </div>
                     </div>
                     <div class="spacer10px"></div>
                     <div class="loading" id="loadingeditbestelling" style="display: none;">
                         <lottie-player
                             src="/images/loading.json"
                             background="transparent"
                             speed="1"
                             loop
                             autoplay>
                         </lottie-player>
                     </div>
                      <div id="succesvolleupdate" class="w-form-done">Bestelling succesvol geupdate!</div>
                     <button type="submit" class="button intypeholder notabs w-button" id="updateBestellingBtn">Aanpassingen opslagen</button>
                </div>
            </div>

            <div id="orderdetails" style="min-width: 40%; overflow: scroll">
                
            </div>
        </div>
          
      </div>
    </div>
  </div>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=66d843f7aa41c71a1134cb81" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="/js/dash-aanbod.js" type="text/javascript"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCIQlfqz-Hd-Oe0tNjnEfJdwHwMy3JuNr4",
    authDomain: "test-9efbe.firebaseapp.com",
    projectId: "test-9efbe",
    storageBucket: "test-9efbe.appspot.com",
    messagingSenderId: "218327249026",
    appId: "1:218327249026:web:0d48fa588ac45ef557049b",
    measurementId: "G-2ZTZCL27TE"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  function checkAuth() {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("User is logged in:", user);
      } else {
        console.log("No user is logged in");
      }
    });
  }

  window.onload = function() {
    checkAuth();
    displayBestellingen();
    
    // Add event listeners for type selection changes
    document.querySelectorAll('input[name="type"]').forEach((radio) => {
      radio.addEventListener('change', (event) => {
        toggleBusinessPersonalFields(event.target.value);
      });
    });

    // Add event listeners for delivery selection changes
    document.querySelectorAll('input[name="delivery"]').forEach((radio) => {
      radio.addEventListener('change', (event) => {
        toggleDeliveryFields(event.target.value);
      });
    });
  };

  // Function to display bestellingen
  async function displayBestellingen() {
    const bestellingenTable = document.getElementById('bestellingenTable'); // Table container
    const tableFragment = document.createDocumentFragment(); // Fragment for table rows

    try {
      const querySnapshot = await getDocs(collection(db, "Bestellingen"));
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        console.log(data);

        if (!data.verwijderd) { // Only include bestellingen that are not marked as deleted
          const bestellingId = doc.id;
          const bestellingType = data.type;
          const bestellingPhone = data.telephone;
          const bestellingEmail = data.email;
          const bestellingDeliveryPickup = data.deliveryPickup;
          const bestellingBedrijf = data.companyname;
          const bestellingVoornaam = data.firstname;
          const bestellingNaam = data.name;
          const bestellingStatus = data.status || "";
          const bestellingPrijs = data.totalPrice || "";
          const bestellingDozen = data.totalBoxes || "";
          const bestellingDatumAanmaak = data.dateTime || "";
          let bestellingAanspreking;
          let bestellingTypeB2BC;
          let bestellingAdminUserGast;
          if (bestellingType === "business") {
            bestellingAanspreking = bestellingBedrijf;
            bestellingTypeB2BC = "B2B";
          } else if (bestellingType === "personal") {
            bestellingAanspreking = bestellingVoornaam + " " + bestellingNaam;
            bestellingTypeB2BC = "B2C";
          }

          if (data.gastOrUser === "user") {
            bestellingAdminUserGast = "user";
          } else if (data.gastOrUser === "gast") {
            bestellingAdminUserGast = "gast";
          } else if (data.gastOrUser === "admin") {
            bestellingAdminUserGast = "gast";
          }

          // Create table row for the user
          const tableRow = document.createElement('tr');
          
          // Make the row clickable for editing the user
          tableRow.addEventListener('click', () => {
            // Populate the popup with the selected order's details
            populatePopup(data, bestellingType, bestellingId, bestellingDeliveryPickup);
          
            // Show the popup
            const popupEditBestelling = document.getElementById("popupeditbestelling");
            const mainResultsDiv = document.getElementById("mainresults");
            mainResultsDiv.style.display = "none";
            popupEditBestelling.style.display = "flex";
          });
          
          // Create billing and delivery cells
          const billingCell = document.createElement('td');
          const deliveryCell = document.createElement('td');
          
          // Set up billing and delivery addresses
          const billingAddress = `${data.streetnrfact}, ${data.postcodefact} ${data.placefact}`;
          const deliveryAddress = data.samedeliveryadress ? billingAddress : `${data.deliverystreetnr}, ${data.deliverypostcode} ${data.deliveryplace}`;
          
          // Create tooltips
          const billingTooltip = document.createElement('span');
          billingTooltip.className = 'tooltip';
          billingTooltip.innerText = billingAddress;
          billingCell.appendChild(billingTooltip);
          billingCell.innerHTML += `<img class="deleteicon" src="/images/billing-address.png" loading="lazy">`;
          
          const deliveryTooltip = document.createElement('span');
          deliveryTooltip.className = 'tooltip';
          deliveryTooltip.innerText = deliveryAddress;
          deliveryCell.appendChild(deliveryTooltip);
          deliveryCell.innerHTML += `<img class="deleteicon" src="/images/delivery-address.png" loading="lazy">`;
          
          // Add mouseover and mouseout events for the tooltips
          billingCell.onmouseover = () => { billingTooltip.style.display = 'block'; };
          billingCell.onmouseout = () => { billingTooltip.style.display = 'none'; };
          
          deliveryCell.onmouseover = () => { deliveryTooltip.style.display = 'block'; };
          deliveryCell.onmouseout = () => { deliveryTooltip.style.display = 'none'; };
          
          // Add table row content (except for delete button)
          tableRow.innerHTML = `
            <td>${bestellingAanspreking}</td>
            <td>${bestellingId}</td>
            <td>${bestellingAdminUserGast}</td>
            <td>${bestellingDeliveryPickup}</td>
            <td>${bestellingTypeB2BC}</td>
            <td>${bestellingStatus}</td>
            <td>${bestellingPrijs}</td>
            <td>${bestellingDozen}</td>
            <td>${bestellingEmail}</td>
            <td>${bestellingPhone}</td>
          `;
          
          // Append the cells to the row
          tableRow.appendChild(billingCell);
          if (bestellingDeliveryPickup === "delivery") {
            tableRow.appendChild(deliveryCell);
          } else {
            const emptyCell = document.createElement('td');
            tableRow.appendChild(emptyCell);
          }
          
          // Append the row to the table fragment
          tableFragment.appendChild(tableRow);
        }
      });

    } catch (error) {
      console.error('Error fetching documents: ', error);
    }

    // Update the table
    const tableBody = bestellingenTable.querySelector('tbody');
    tableBody.innerHTML = ''; // Clear existing table rows
    tableBody.appendChild(tableFragment); // Add new rows to the table
  }

  function deleteCookie(name) {
    document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
  }

  document.addEventListener('DOMContentLoaded', () => {
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      signOut(auth).then(() => {
        console.log('User signed out.');
        deleteCookie('token');
        deleteCookie('userId');
        // Redirect to login page
        window.location.href = '/index';
      }).catch((error) => {
        console.error('Error signing out:', error);
      });
    });
  });

  document.getElementById("closepopupeditbestelling").addEventListener("click", function() {
    const popupEditBestelling = document.getElementById("popupeditbestelling");
    popupEditBestelling.style.display = "none";
    const mainResultsDiv = document.getElementById("mainresults");
    mainResultsDiv.style.display = "flex";
  });

  function populatePopup(data, bestellingType, bestellingId, bestellingDeliveryPickup) {
    // Set the radio buttons based on bestelling type
    const personalRadio = document.querySelector('input[name="type"][value="personal"]');
    const businessRadio = document.querySelector('input[name="type"][value="business"]');
    personalRadio.checked = (bestellingType === 'personal');
    businessRadio.checked = (bestellingType === 'business');

    const deliveryRadio = document.querySelector('input[name="delivery"][value="delivery"]');
    const pickupRadio = document.querySelector('input[name="delivery"][value="pickup"]');
    deliveryRadio.checked = (bestellingDeliveryPickup === 'delivery');
    pickupRadio.checked = (bestellingDeliveryPickup === 'pickup');

    // Show/hide fields based on type
    toggleBusinessPersonalFields(bestellingType);
    toggleDeliveryFields(bestellingDeliveryPickup);

    // Populate fields with order data
    document.getElementById('detailbestid').textContent = `Bestelling ID: ${bestellingId}`;
    document.getElementById('updateid').value = bestellingId;
    document.getElementById('email').value = data.email || '';
    document.getElementById('telephone').value = data.telephone || '';
    document.getElementById('firstname').value = data.firstname || '';
    document.getElementById('name').value = data.name || '';
    document.getElementById('companyname').value = data.companyname || '';
    document.getElementById('btwnr').value = data.btwnr || '';
    document.getElementById('streetnrfact').value = data.streetnrfact || '';
    document.getElementById('postcodefact').value = data.postcodefact || '';
    document.getElementById('placefact').value = data.placefact || '';

    // Populate delivery address
    document.getElementById('deliverystreetnr').value = data.deliverystreetnr || '';
    document.getElementById('deliverypostcode').value = data.deliverypostcode || '';
    document.getElementById('deliveryplace').value = data.deliveryplace || '';

    // Populate order details table
    const orderDetailsDiv = document.getElementById('orderdetails');
    orderDetailsDiv.innerHTML = '<div class="spacer10px"></div><div class="spacer10px"></div>';

    // Create table structure
    const table = document.createElement('table');
    table.classList.add('styled-table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Prijs</th>
                <th>Totaal</th>
                <th>Product ID</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');

    // Loop through each product and create table rows
    data.products.forEach(product => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${product.name}</td>
            <td>${product.quantity}</td>
            <td>${product.price}</td>
            <td>${product.total}</td>
            <td>${product.productId}</td>
        `;
        tbody.appendChild(row);
    });

    // Append the table to the orderdetails div
    orderDetailsDiv.appendChild(table);
}

  function toggleBusinessPersonalFields(type) {
    const personalDiv = document.getElementById('personaldiv');
    const businessDiv = document.getElementById('businessdiv');
    if (type === 'personal') {
      personalDiv.style.display = 'block';
      businessDiv.style.display = 'none';
    } else if (type === 'business') {
      personalDiv.style.display = 'none';
      businessDiv.style.display = 'block';
    }
  }

  function toggleDeliveryFields(deliveryPickup) {
    const deliveryDiv = document.getElementById('deliverydiv');
    if (deliveryPickup === 'pickup') {
      deliveryDiv.style.display = 'none';
    } else {
      deliveryDiv.style.display = 'block';
    }
  }

  // Function to update bestellingen
  async function updateBestelling(bestellingId) {
    document.getElementById('updateBestellingBtn').style.display = "none";
    document.getElementById('loadingeditbestelling').style.display = "block";
    const bestellingType = document.querySelector('input[name="type"]:checked').value;
    const bestellingDeliveryPickup = document.querySelector('input[name="delivery"]:checked').value;

    // Gather updated data from the form
    const updatedData = {
      type: bestellingType,
      deliveryPickup: bestellingDeliveryPickup,
      email: document.getElementById('email').value,
      telephone: document.getElementById('telephone').value,
      firstname: document.getElementById('firstname').value,
      name: document.getElementById('name').value,
      companyname: document.getElementById('companyname').value,
      btwnr: document.getElementById('btwnr').value,
      streetnrfact: document.getElementById('streetnrfact').value,
      postcodefact: document.getElementById('postcodefact').value,
      placefact: document.getElementById('placefact').value,
      deliverystreetnr: document.getElementById('deliverystreetnr').value,
      deliverypostcode: document.getElementById('deliverypostcode').value,
      deliveryplace: document.getElementById('deliveryplace').value,
    };

    try {
      const docRef = doc(db, "Bestellingen", bestellingId);
      await updateDoc(docRef, updatedData);
      console.log('Bestelling updated successfully!');
      // Optionally refresh the display or close the popup
      displayBestellingen();
      const succesvolleupdate = document.getElementById("succesvolleupdate");
      document.getElementById('loadingeditbestelling').style.display = "none";
      succesvolleupdate.style.display = "block";
      setTimeout(() => {
        succesvolleupdate.style.display = "none";
        document.getElementById('updateBestellingBtn').style.display = "block";
      }, 5000);
    } catch (error) {
      console.error('Error updating bestelling: ', error);
      document.getElementById('updateBestellingBtn').style.display = "block";
    }
  }

  // Add event listener for the update button in the popup
  document.getElementById('updateBestellingBtn').addEventListener('click', () => {
    const bestellingId = document.getElementById('updateid').value; // Replace with actual way to get ID
    updateBestelling(bestellingId);
  });

</script>

<script>

function exportTableToXLSX(tableId) {
    const table = document.getElementById(tableId);
    const workbook = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
    XLSX.writeFile(workbook, "backup.xlsx");
}
</script>

</html>
